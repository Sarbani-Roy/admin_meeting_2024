<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suitability of Your Research Indexing</title>
    <style>
        #suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 50%;
            max-height: 150px;
            overflow-y: auto;
            background-color: lightblue;
            display: none;
            z-index: 1;
            list-style: none;
        }

        #suggestions li {
            padding: 5px;
            cursor: pointer;
            user-select: none;
            list-style: none;
        }

        .choose-keyword-container {
            position: relative;
        }

        #suggestions li.selected {
            background-color: #ddd; /* Gray background for selected suggestion */
        }

    </style>
</head>
<body>
    <h1>Suitability of Your Research Indexing</h1>
    <form id="dataForm">
        
        <label for="subject_area">
            How would you describe the subject area in which you conduct your research?<br>
            (Wie würden Sie den Fachbereich benennen, in dem Sie arbeiten, bzw. ihre Forschung betreiben?)
        </label><br>
        <div id="subjectAreasContainer">
            <div class="input-group">
                <input type="text" name="subject_area[]" required>
            </div>
                
            <button type="button" onclick="addInput('subjectAreasContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>

        <label for="research_field">
            How would you describe your field of research?<br>
            (Wie würden Sie ihr Forschungsgebiet benennen?) 
        </label><br>
        <div id="researchFieldContainer">
            <div class="input-group">
                <input type="text" name="research_field[]" required>
            </div>
            
            <button type="button" onclick="addInput('researchFieldContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>

        <label for="choose_discipline">
            Please choose from the following list the discipline(s) that match your research area best.<br>
            (Bitte wählen Sie aus der folgenden Liste das Fach/die Fächer aus, die am besten zu ihrem Forschungsgebiet passen.) 
        </label><br>
        <div id="chooseDisciplineContainer">
            <div class="input-group">
                <input type="text" name="choose_discipline[]" required>
            </div>
            
            <button type="button" onclick="addInput('chooseDisciplineContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>

        <label for="user_keyword">
            Please mention few keywords that describes your research best.<br>
            (Bitte wählen Sie aus der folgenden Liste das Fach/die Fächer aus, die am besten zu ihrem Forschungsgebiet passen.) 
        </label><br>
        <div id="userKeywordContainer">
            <div class="input-group">
                <input type="text" name="user_keyword[]" required>
            </div>
            
            <button type="button" onclick="addInput('userKeywordContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>
        
        <label for="choose_keyword">
        Please try to find those keywords in following vocabularies. You may start typing and use suggestion list from the corresponding vocabulary to find.<br>
        (Bitte wählen Sie aus den folgenden Stichworten eines aus, das Ihre Forschung am besten beschreibt.) 
        </label><br>
        <label for="wikidata">
            Wikidata:
        </label><br>
        <div id="chooseKeywordContainer">
            <div class="input-group">
                <label for="keyword">Term:</label>
                <input type="text" name="choose_keyword[]" id="keyword" placeholder="Enter a keyword" value="{{ user_input }}" style="width: 80%;"><br>
                <ul id="suggestions"></ul>

                <label for="keywordID">Keyword ID:</label>
                <input type="text" name="choose_keywordid[]" id="keywordID" placeholder="Keyword ID">
                
                <label for="controlledVocabularyURL">Controlled Vocabulary URL:</label>
                <input type="text" name="choose_cvoc_url[]" id="controlledVocabularyURL" placeholder="Controlled Vocabulary URL">                
            </div>        

            <button type="button" onclick="addInput('chooseKeywordContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>
        <label for="TEMA">
            TEMA:
        </label><br>
        <div id="temaKeywordContainer">
          

            <button type="button" onclick="addInput('chooseKeywordContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>

        <label for="vocab_reco">
            Please recommend some vocabulary related to your research area.<br>
            (Bitte wählen Sie aus der folgenden Liste das Fach/die Fächer aus, die am besten zu ihrem Forschungsgebiet passen.) 
        </label><br>
        <div id="vocabRecoContainer">
            <div class="input-group">
                <input type="text" name="vocab_reco[]" required>
            </div>
            
            <button type="button" onclick="addInput('vocabRecoContainer')">+</button>
            <button type="button" onclick="removeInput(this)">-</button>
        </div><br>

        <label for="name">Please mention the name of the Dataverse you are adminstrating:</label>
        <input type="text" id="name" name="name" class="name-input" required><br>

        <label for="subject_area_discipline_match">
            How well does the selected subject match your research area?<br>
            (Wie gut beschreibt die ausgewählte Bezeichnung ihr Fachgebiet?)
        </label><br>
        <div class="likert-scale">
            <label>Does not fit at all</label>
            <input type="radio" name="likert_scale_subject[]" value="1" required ><br>

            <label>Does rather not fit</label>
            <input type="radio" name="likert_scale_subject[]" value="2" required><br>

            <label>Fits somewhat</label>
            <input type="radio" name="likert_scale_subject[]" value="3" required><br>

            <label>Fits well</label>
            <input type="radio" name="likert_scale_subject[]" value="4" required><br>

            <label>Fits perfectly</label>
            <input type="radio" name="likert_scale_subject[]" value="5" required>
        </div><br>

        <label for="keyword_match">
            Would the selected term be suitable to search for research results (papers, data) in your field? <br>
            (Wäre der ausgewählte Begriff geeignet, um nach Forschungsergebnissen (Papern, Daten) in ihrem Gebiet zu suchen?)
        </label><br>
        <div class="likert-scale">
            <label>Completely unsuitable</label>
            <input type="radio" name="likert_scale_keyword[]" value="1" required><br>

            <label>Disagree</label>
            <input type="radio" name="likert_scale_keyword[]" value="2" required><br>

            <label>Neither agree nor disagree</label>
            <input type="radio" name="likert_scale_keyword[]" value="3" required><br>

            <label>Agree</label>
            <input type="radio" name="likert_scale_keyword[]" value="4" required><br>

            <label>Strongly agree</label>
            <input type="radio" name="likert_scale_keyword[]" value="5" required>
        </div><br>

        <label for="description_match">
            Would the selected term be suitable to search for research results (papers, data) in your field? <br>
            (Wäre der ausgewählte Begriff geeignet, um nach Forschungsergebnissen (Papern, Daten) in ihrem Gebiet zu suchen?)
        </label><br>
        <div class="likert-scale">
            <label>Much too coarse</label>
            <input type="radio" name="likert_scale_description[]" value="1" required><br>

            <label>A little too coarse</label>
            <input type="radio" name="likert_scale_description[]" value="2" required><br>

            <label>Fits exactly</label>
            <input type="radio" name="likert_scale_description[]" value="3" required><br>

            <label>A little too detailed</label>
            <input type="radio" name="likert_scale_description[]" value="4" required><br>

            <label>Much too detailed</label>
            <input type="radio" name="likert_scale_description[]" value="5" required>
        </div><br>

        <label for="index_suggestion">Suggestions:</label><br>
        <textarea id="index_suggestion" name="index_suggestion" class="index_suggestion-input" rows="4" cols="50" required></textarea><br>


        <button type="button" onclick="submitForm()">Submit</button>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>

        // To set the position of the suggestions list
        function positionSuggestionsList() {
            
            const inputRect = keywordInput.getBoundingClientRect();
            console.log('Input Rect:', inputRect);
            suggestionsList.style.top = inputRect.bottom + 'px';
            suggestionsList.style.left = inputRect.left + 'px';
            suggestionsList.style.width = inputRect.width + 'px'; // Set width to match the input box
        }

        const keywordInput = document.getElementById('keyword');
        const keywordIDInput = document.getElementById('keywordID');
        const controlledVocabularyURLInput = document.getElementById('controlledVocabularyURL');
        const suggestionsList = document.getElementById('suggestions');
        let selectedIndex = -1;
        let keyword_data = [];

        keywordInput.addEventListener('input', function () {
            const user_input = keywordInput.value.toLowerCase();
            fetch(`/search?keywordInput=${user_input}`)
                .then(response => response.json())
                .then(dataResponse => {
                    keyword_data = dataResponse;
                    suggestionsList.innerHTML = '';
                    selectedIndex = -1;

                    keyword_data.forEach((keyword, index) => {
                        const suggestion = document.createElement('li');
                        suggestion.textContent = keyword[0];
                        suggestion.addEventListener('click', function () {
                            keywordInput.value = keyword[0];
                            keywordIDInput.value = keyword[1];
                            controlledVocabularyURLInput.value = keyword[4];
                            suggestionsList.style.display = 'none';
                        });
                        suggestion.addEventListener('mouseenter', function () {
                            selectSuggestion(index);
                        });
                        suggestionsList.appendChild(suggestion);
                    });

                    if (keyword_data.length > 0) {
                        suggestionsList.style.display = 'block';
                        positionSuggestionsList();
                    } else {
                        suggestionsList.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        keywordInput.addEventListener('keydown', function (event) {
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                scrollSuggestions('up');
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                scrollSuggestions('down');
            } else if (event.key === 'Enter') {
                event.preventDefault();
                const selectedSuggestion = suggestionsList.children[selectedIndex];
                if (selectedSuggestion) {
                    const keyword = keyword_data[selectedIndex];
                    keywordInput.value = keyword[0];
                    keywordIDInput.value = keyword[1];
                    controlledVocabularyURLInput.value = keyword[4];
                    suggestionsList.style.display = 'none';
                }
            }
        });

        //  event listeners to handle mouse selection and highlight suggestions
        suggestionsList.addEventListener('mouseover', function (event) {
            if (event.target.tagName === 'LI') {
                selectSuggestion(Array.from(event.target.parentNode.children).indexOf(event.target));
            }
        });

        suggestionsList.addEventListener('mouseout', function () {
            selectedIndex = -1;
            selectSuggestion(selectedIndex);
        });

        keywordInput.addEventListener('focus', function () {
            if (selectedIndex !== -1) {
                selectSuggestion(selectedIndex);
            }
        });

        keywordInput.addEventListener('blur', function () {
            selectedIndex = -1;
            selectSuggestion(selectedIndex);
        });    

        function scrollSuggestions(direction) {
            const suggestions = suggestionsList.children;

            if (suggestions.length > 0) {
                if (direction === 'up' && selectedIndex > 0) {
                    selectedIndex -= 1;
                } else if (direction === 'down' && selectedIndex < suggestions.length - 1) {
                    selectedIndex += 1;
                }

                selectedIndex = Math.max(0, Math.min(selectedIndex, suggestions.length - 1));

                for (let i = 0; i < suggestions.length; i++) {
                    suggestions[i].classList.remove('selected');
                }

                const selectedSuggestion = suggestions[selectedIndex] || null;

                if (selectedSuggestion) {
                    selectedSuggestion.classList.add('selected');
                    
                    const offsetTop = selectedSuggestion.offsetTop;
                    const scrollPosition = suggestionsList.scrollTop;
                    const scrollHeight = suggestionsList.scrollHeight;

                    if (offsetTop < scrollPosition) {
                        suggestionsList.scrollTop = offsetTop;
                    } else if (offsetTop + selectedSuggestion.clientHeight > scrollPosition + suggestionsList.clientHeight) {
                        suggestionsList.scrollTop = offsetTop + selectedSuggestion.clientHeight - suggestionsList.clientHeight;
                    }
                }
            }
        }


        function selectSuggestion(index) {
            selectedIndex = index;
            const suggestions = suggestionsList.children;

            for (let i = 0; i < suggestions.length; i++) {
                suggestions[i].classList.remove('selected');
            }

            suggestions[selectedIndex].classList.add('selected');
        }

        function addInput(containerId) {
            var container = document.getElementById(containerId);

            // Clone the original input group within the specified container
            var originalInputGroup = container.querySelector('.input-group');
            var newInputGroup = originalInputGroup.cloneNode(true);

            // Reset values in the cloned input group
            var inputs = newInputGroup.querySelectorAll('input[type="text"]');
            inputs.forEach(function (input) {
                input.value = '';
            });

            // Create a new button element for add
            var addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.textContent = '+';
            addButton.onclick = function () {
                addInput(containerId);
            };

            // Create a new button element for removal
            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.textContent = '-';
            removeButton.onclick = function () {
                removeInput(this);
            };

            // Append the new input group, add button, and remove button to the container
            var newContainer = document.createElement('div');
            newContainer.classList.add(getContainerClass(containerId));
            newContainer.appendChild(newInputGroup);
            newContainer.appendChild(addButton);
            newContainer.appendChild(removeButton);

            // Insert the new container after the current container
            container.parentNode.insertBefore(newContainer, container.nextSibling);
        }

        function getInputName(containerId) {
            switch (containerId) {
                case 'subjectAreasContainer':
                    return 'subject_area[]';
                case 'researchFieldContainer':
                    return 'research_field[]';
                case 'chooseDisciplineContainer':
                    return 'choose_discipline[]';
                case 'userKeywordContainer':
                    return 'user_keyword[]';
                case 'chooseKeywordContainer':
                    return 'choose_keyword[]', 'choose_keywordid[]', 'choose_cvoc_url[]';
                case 'vocabRecoContainer':
                    return 'vocab_reco[]';
                default:
                    return '';
            }
        }

        function getContainerClass(containerId) {
            switch (containerId) {
                case 'subjectAreasContainer':
                    return 'subject-area-container';
                case 'researchFieldContainer':
                    return 'research-field-container';
                case 'chooseDisciplineContainer':
                    return 'choose-discipline-container';
                case 'userKeywordContainer':
                    return 'user-keyword-container';
                case 'chooseKeywordContainer':
                    return 'choose-keyword-container';
                case 'vocabRecoContainer':
                    return 'vocab-reco-container';
                default:
                    return '';
            }
        }

        function removeInput(button) {
            var container = button.parentNode;

            // Extract the container class from the container
            var containerClass = container.classList[0];

            // Ensure there's at least one input before trying to remove
            if (document.querySelectorAll('.' + containerClass).length >= 1) {
                container.parentNode.removeChild(container);
            }
        }

        function submitForm() {

            var name = $('#name').val();
            var index_suggestion = $('#index_suggestion').val()
            var data = { 
                name: name,
                subject_area: $('input[name="subject_area[]"]').map(function () {
                    return this.value;
                }).get(),
                research_field: $('input[name="research_field[]"]').map(function () {
                    return this.value;
                }).get(),
                choose_discipline: $('input[name="choose_discipline[]"]').map(function () {
                    return this.value;
                }).get(),
                user_keyword: $('input[name="user_keyword[]"]').map(function () {
                    return this.value;
                }).get(),                
                choose_keyword: $('input[name="choose_keyword[]"]').map(function () {
                    return this.value
                }).get(),
                choose_keywordid: $('input[name="choose_keywordid[]"]').map(function () {
                    return this.value
                }).get(),
                choose_cvoc_url: $('input[name="choose_cvoc_url[]"]').map(function () {
                    return this.value
                }).get(),
                vocab_reco: $('input[name="vocab_reco[]"]').map(function () {
                    return this.value;
                }).get(),  
                subject_area_discipline_match: $('input[name="likert_scale_subject[]"]:checked').val() || '',
                keyword_match: $('input[name="likert_scale_keyword[]"]:checked').val() || '',
                description_match: $('input[name="likert_scale_description[]"]:checked').val() || '',
                index_suggestion: index_suggestion
            };

            $.ajax({
                type: 'POST',
                url: '/submit',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(data),
                success: function(response) {
                    alert('Data submitted successfully!');
                    $('#dataForm')[0].reset();
                },
                error: function(error) {
                    console.error('Error:', error);
                    alert('An error occurred while submitting the form.');
                }
            });
        }
    </script>
</body>
</html>